<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AidGen</title>
    <!-- Link to local stylesheet for dark mode styling -->
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header>
      <h1 class="title">AidGen</h1>
    </header>
    <main>
      <!-- Form section: collects coffee details -->
      <section id="form-section" class="card">
        <form id="brew-form" class="form">
          <div class="grid">
            <div class="form-group">
              <label for="name">Name</label>
              <input id="name" name="name" type="text" placeholder="Enter coffee name" />
            </div>
            <div class="form-group">
              <label for="roast">Roast profile</label>
              <select id="roast" name="roast">
                <option value="" disabled selected>Select roast profile</option>
                <option>light</option>
                <option>light/medium</option>
                <option>medium</option>
                <option>medium/dark</option>
                <option>dark</option>
              </select>
            </div>
            <div class="form-group">
              <label for="origin">Origin</label>
              <select id="origin" name="origin">
                <option value="" disabled selected>Select origin</option>
                <option>Colombia</option>
                <option>Ethiopia</option>
                <option>Kenya</option>
                <option>Guatemala</option>
                <option>Brazil</option>
                <option>Honduras</option>
                <option>Costa Rica</option>
                <option>Panama</option>
                <option>El Salvador</option>
                <option>Rwanda</option>
                <option>Burundi</option>
                <option>Mexico</option>
                <option>Peru</option>
                <option>Tanzania</option>
                <option>Papua New Guinea</option>
                <option>Indonesia</option>
                <option>Yemen</option>
              </select>
            </div>
            <div class="form-group">
              <label for="process">Processing method</label>
              <select id="process" name="process">
                <option value="" disabled selected>Select processing method</option>
                <option>Washed</option>
                <option>Natural</option>
                <option>Honey</option>
                <option>Anaerobic</option>
                <option>Wet-Hulled</option>
                <option>Double Anaerobic</option>
                <option>Carbonic Maceration</option>
                <option>Co Fermentation</option>
              </select>
            </div>
            <div class="form-group">
              <label for="varietal">Varietal</label>
              <select id="varietal" name="varietal">
                <option value="" disabled selected>Select varietal</option>
                <option>Typica</option>
                <option>Bourbon</option>
                <option>Yellow Bourbon</option>
                <option>Red Bourbon</option>
                <option>Pink Bourbon</option>
                <option>Orange Bourbon</option>
                <option>Gesha</option>
                <option>Geisha</option>
                <option>Caturra</option>
                <option>Catuai</option>
                <option>Yellow Catuai</option>
                <option>Red Catuai</option>
                <option>SL28</option>
                <option>SL34</option>
                <option>SL14</option>
                <option>SL24</option>
                <option>Pacamara</option>
                <option>Pacas</option>
                <option>Mundo Novo</option>
                <option>Maragogype</option>
                <option>Kent</option>
                <option>Blue Mountain</option>
                <option>Kona</option>
                <option>Rume Sudan</option>
                <option>Villalobos</option>
                <option>Java</option>
                <option>Castillo</option>
                <option>Hibrido de Timor</option>
                <option>Catimor</option>
                <option>Sarchimor</option>
                <option>Pache</option>
                <option>Colombia</option>
                <option>Tabi</option>
                <option>Parainema</option>
                <option>Obata</option>
                <option>Mibirizi</option>
                <option>Laurina</option>
                <option>Ethiopian Heirloom</option>
                <option>F1 Hybrids (Centroamericano)</option>
                <option>Sidra</option>
                <option>Chiroso</option>
                <option>Wush Wush</option>
              </select>
            </div>
            <div class="form-group">
              <label for="masl">MASL (optional)</label>
              <input id="masl" name="masl" type="number" min="0" step="1" placeholder="e.g. 1200" />
            </div>
            <div class="form-group">
              <label for="roastDate">Roast date</label>
              <input id="roastDate" name="roastDate" type="date" />
            </div>
            <div class="form-group">
              <label for="brewProfile">Brew profile</label>
              <select id="brewProfile" name="brewProfile">
                <option value="" disabled selected>Select brew profile</option>
                <option>clarity first</option>
                <option>body first</option>
                <option>balanced</option>
              </select>
            </div>
          </div>
          <div class="button-container">
            <button type="submit" id="submit-btn" class="btn">RECIPE ME</button>
          </div>
        </form>
      </section>
      <!-- Recipe section: displays generated recipe and allows for another recipe generation -->
      <section id="recipe-section" class="card hidden">
        <div class="button-container" style="justify-content:flex-start; margin-bottom:1rem;">
          <button id="another-btn" class="btn secondary">ANOTHER RECIPE</button>
        </div>
        <h2 class="section-title">Generated Recipe</h2>
        <div id="result-output" class="result"></div>
        <div class="button-container">
          <button id="copy-btn" class="btn secondary">Copy to clipboard</button>
        </div>
      </section>
      <!-- Loading indicator: hidden by default, displayed while generating -->
      <section id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Generating your recipeâ€¦</p>
      </section>
    </main>
    <script>
      async function generateRecipe(event) {
        event.preventDefault();
        const submitBtn = document.getElementById('submit-btn');
        const loadingEl = document.getElementById('loading');
        const recipeSection = document.getElementById('recipe-section');
        const formSection = document.getElementById('form-section');
        const resultOutput = document.getElementById('result-output');
        const copyBtn = document.getElementById('copy-btn');
        // Show loading indicator and disable submit button
        loadingEl.style.display = 'flex';
        submitBtn.disabled = true;
        const form = document.getElementById('brew-form');
        const formData = new FormData(form);
        const params = {};
        for (const [key, value] of formData.entries()) {
          if (value && !value.startsWith('Select')) {
            params[key] = value;
          }
        }
        try {
          const response = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(params),
          });
          if (!response.ok) {
            throw new Error(`Server responded with ${response.status}`);
          }
          const data = await response.json();
          resultOutput.innerHTML = data.html || '<p>No recipe returned.</p>';
          // Hide form and show recipe section
          formSection.classList.add('hidden');
          recipeSection.classList.remove('hidden');
          // Setup copy to clipboard
          copyBtn.onclick = () => {
            const temp = document.createElement('textarea');
            temp.value = resultOutput.innerText;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            copyBtn.textContent = 'Copied!';
            setTimeout(() => (copyBtn.textContent = 'Copy to clipboard'), 1500);
          };
        } catch (err) {
          resultOutput.innerHTML = `<p class="error">Error: ${err.message}</p>`;
          formSection.classList.add('hidden');
          recipeSection.classList.remove('hidden');
        } finally {
          // Hide loading indicator and re-enable submit button
          loadingEl.style.display = 'none';
          submitBtn.disabled = false;
        }
      }
      document.getElementById('brew-form').addEventListener('submit', generateRecipe);
      // Handle generating another recipe
      const anotherBtn = document.getElementById('another-btn');
      anotherBtn.addEventListener('click', () => {
        const recipeSection = document.getElementById('recipe-section');
        const formSection = document.getElementById('form-section');
        const resultOutput = document.getElementById('result-output');
        // Clear previous results
        resultOutput.innerHTML = '';
        // Reset copy button text
        document.getElementById('copy-btn').textContent = 'Copy to clipboard';
        // Show form and hide recipe view
        formSection.classList.remove('hidden');
        recipeSection.classList.add('hidden');
        // Ensure loading spinner is hidden
        document.getElementById('loading').style.display = 'none';
      });
    </script>
  </body>
</html>
